<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Circuit Diagram Analyzer</title>

  <!-- Tailwind CSS -->
  <link href="{{ url_for('static', filename='css/tailwind-output.css') }}" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Existing custom styles */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* The bottom container that toggles its height from 1cm to 15cm */
    #previous-threads {
      height: 1cm;
      width: 15cm;
      transition: height 0.3s ease-in-out;
      overflow: hidden;
      border-radius: 0;
      background: transparent;
      z-index: 20;
    }

    #arrow-icon {
      transition: transform 0.3s ease-in-out;
    }
    .rotate-180 {
      transform: rotate(180deg);
    }

    .disabled {
      opacity: 0.6;
      cursor: not-allowed !important; /* Force not-allowed cursor */
    }

    .selected-thread {
      background-color: #AFE1AF !important; /* Light green background */
      border-color: #badbcc !important; /* Green border */
    }

    /* Loading circle styles */
    .loading-circle {
      border: 4px solid #e2e2e2; /* light gray */
      border-top: 4px solid #3498db; /* blue color */
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Instruction Modal */
    #instruction-modal {
      display: none; /* hidden by default */
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #instruction-modal.show {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    /* New Project Modal */
    #new-project-modal {
      display: none; /* hidden by default */
    }
    #new-project-modal.show {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Download Modal */
    #download-modal {
      display: none; /* hidden by default */
    }
    #download-modal.show {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    .error-message {
      color: red;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div id="flash-messages" class="fixed top-4 right-4 z-50 flex flex-col space-y-2">
        {% for category, message in messages %}
          {% if category != 'login_success' %}
            <div class="px-4 py-2 rounded shadow-lg text-white
              {% if category == 'logout_success' %}
                bg-blue-500
              {% elif category == 'error' %}
                bg-red-500
              {% else %}
                bg-gray-500
              {% endif %}
            ">
              {{ message }}
            </div>
          {% endif %}
        {% endfor %}
      </div>
      <script>
        // Automatically hide flash messages after 5 seconds
        setTimeout(() => {
          const flashContainer = document.getElementById('flash-messages');
          if (flashContainer) {
            flashContainer.style.display = 'none';
          }
        }, 5000);
      </script>
    {% endif %}
  {% endwith %}

  <!-- Instruction Modal -->
  <div id="instruction-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full relative">
      <!-- Close '×' Button at Top-Right Corner -->
      <button
        id="instruction-modal-close-x"
        class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 focus:outline-none w-5 h-5 flex items-center justify-center"
        aria-label="Close Instruction Modal"
      >
        <!-- SVG Close Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h2 class="text-xl font-semibold mb-4">Welcome!</h2>
      <p class="text-gray-700 mb-6">
        To begin, please enter the project name in the text field above.
      </p>
      <div class="flex justify-end">
        <button id="instruction-close" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
          I Understand
        </button>
      </div>
    </div>
  </div>

  <!-- New Project Modal -->
  <div id="new-project-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full relative">
      <!-- Close '×' Button at Top-Right Corner -->
      <button
        id="new-project-modal-close-x"
        class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 focus:outline-none w-5 h-5 flex items-center justify-center"
        aria-label="Close New Project Modal"
      >
        <!-- SVG Close Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h2 class="text-xl font-semibold mb-4">Create New Project</h2>
      <label class="block mb-2 text-gray-700">Project Name:</label>
      <input
        type="text"
        id="new-project-input"
        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Enter new project name..."
      />
      <p id="new-project-error" class="error-message hidden"></p>

      <div class="flex justify-end mt-4">
        <button id="confirm-new-project"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition"
        >
          Confirm
        </button>
      </div>
    </div>
  </div>

  <!-- Download Modal (Newly Added) -->
  <div id="download-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full relative">
      <!-- Close '×' Button at Top-Right Corner -->
      <button
        id="download-modal-close-x"
        class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 focus:outline-none w-5 h-5 flex items-center justify-center"
        aria-label="Close Download Modal"
      >
        <!-- SVG Close Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <h2 class="text-xl font-semibold mb-4">Download Excel</h2>
      <p id="downloadMessage" class="text-gray-700 mb-6">
        <!-- Will be filled dynamically with the project name -->
      </p>
      <div class="flex justify-end">
        <button id="confirm-download"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition"
        >
          Confirm Download
        </button>
      </div>
    </div>
  </div>

  <!-- Heading / Nav bar -->
  <div class="bg-white shadow mb-[-20px] px-3 py-2 flex justify-between items-center">
    <div class="flex items-center gap-5">
      <!-- Show current project name in the heading -->
      <h2 class="text-[15px] font-bold text-gray-700">
        You are working on:
        <span id="displayed-thread-name" class="text-blue-700">
          {{ last_thread if last_thread else 'No projects created yet.' }}
        </span>
      </h2>
    </div>
    <div class="flex items-center gap-3">
      <div style="display: inline-block">
        <button
          id="create-new-thread"
          class="bg-white text-black px-2 py-1 rounded-lg hover:bg-gray-200 transition flex items-center justify-center"
          title="Create new thread"
          style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);"
        >
          <!-- SVG Plus Icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 4v16m8-8H4" />
          </svg>
        </button>
      </div>

      <!-- Logged in as section -->
      <span class="text-gray-700">Logged in as: <strong>{{ username }}</strong></span>

      <!-- Logout button -->
      <div style="display: inline-block">
        <button
          id="logout-button"
          class="bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600 transition"
        >
          Logout
        </button>
      </div>
    </div>
  </div>

  <!-- Fullscreen overlay (initially hidden). For the "Previous Projects" panel. -->
  <div
    id="screen-overlay"
    class="fixed inset-0 bg-black bg-opacity-60 hidden z-10"
  ></div>

  <div class="container mx-auto py-10 px-2 relative top-[-5px] left-5">
    <!-- Main layout container -->
    <div class="bg-white rounded-lg shadow-lg w-[calc(100%-37.8px)] h-[662.2px] grid grid-cols-2 gap-6 p-6 relative">
      <!-- Left box: Display uploaded image -->
      <div class="relative">
        <label
          for="file-upload"
          id="image-container"
          class="flex flex-col justify-center items-center border-2 border-dashed border-gray-300 rounded-lg p-1 bg-gray-100 cursor-pointer h-full disabled"
          data-disabled="true"
          title="Create or open a project to enable image upload."
        >
          <p class="text-gray-500">Click here to upload an image</p>
          <img
            id="uploaded-image"
            class="hidden max-h-full max-w-full object-contain rounded-lg"
          />
          <input
            type="file"
            id="file-upload"
            name="file"
            accept=".png,.jpg,.jpeg"
            class="hidden"
            disabled
          />
        </label>

        <!-- Upload more button (hidden initially) -->
        <div
          id="upload-more"
          class="hidden absolute bottom-2 right-4 flex items-center gap-1 cursor-pointer text-gray-600 hover:text-gray-900 disabled"
          data-disabled="true"
          title="Create or open a project to upload more images."
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-5 h-5"
          >
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          <span class="text-sm">Upload more</span>
          <input
            type="file"
            id="additional-upload"
            accept=".png,.jpg,.jpeg"
            class="hidden"
            disabled
          />
        </div>
      </div>

      <!-- Right box: Structured Output -->
      <div class="flex flex-col h-full">
        <!-- Header with "SLD Data" and loading circle + percentage -->
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-bold text-gray-700">SLD Data</h2>
          <div class="flex items-center gap-2">
            <!-- The loading circle + percentage text (initially hidden) -->
            <div id="loading-indicator" class="hidden flex items-center">
              <div class="loading-circle"></div>
              <span id="loading-percent" class="text-sm font-medium text-gray-700">0%</span>
            </div>
          </div>
        </div>

        <!-- The content area -->
        <div class="flex-1 relative">
          <div
            id="ocr-output"
            class="absolute inset-0 bg-gray-100 border rounded-lg p-1 overflow-y-auto custom-scrollbar"
          >
            <p class="text-gray-500">SLD image data will appear here</p>
          </div>
        </div>

        <!-- Image navigation bar -->
        <div id="image-nav" class="hidden mt-4 grid gap-2 grid-flow-col auto-cols-fr">
          <!-- Navigation buttons will be added here dynamically -->
        </div>
      </div>
    </div>

    <!-- Download Button & Download Progress -->
    <div class="fixed bottom-1 right-5 flex items-center gap-2">
      <button
        id="download-btn"
        class="bg-[#4CBB17] text-white px-2 py-1 rounded-lg shadow-lg hover:bg-green-600 hidden disabled"
        data-disabled="true"
        title="Download is available once analysis is complete."
      >
        Download
      </button>

      <!-- Download Progress Percentage (Initially hidden) -->
      <span
        id="download-progress"
        class="text-sm font-medium text-gray-700 hidden"
      >
        0%
      </span>
    </div>
  </div>

  <!-- Bottom bar + expanded content in a single container -->
  <div
    id="previous-threads"
    class="fixed bottom-[-20px] left-1/2 transform -translate-x-1/2 mb-4"
  >
    <div
      id="threads-bar"
      class="cursor-pointer flex items-center justify-center gap-2 w-full h-full"
      style="
        height: 1cm;
        align-items: center;
      "
    >
      <span id="previous-threads-label" class="text-gray-700 font-medium">Previous Projects</span>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        id="arrow-icon"
        class="h-5 w-5 text-gray-600 hover:text-gray-800"
        fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
      >
        <!-- Down arrow path: M19 9l-7 7-7-7 -->
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
      </svg>
    </div>
    <!-- The expanded content area -->
    <div
      id="threads-expanded-content"
      class="bg-white flex flex-col w-full h-[calc(15cm-1cm)]"
    >
      <!-- Thread list -->
      <ul
        id="threads-list"
        class="p-4 space-y-2 custom-scrollbar overflow-auto flex-1"
      >
        <!-- Will be populated by JS -->
      </ul>
    </div>
  </div>

  <script>
    // -----------------------------------------------------
    // GLOBAL VARIABLES & DOM REFERENCES
    // -----------------------------------------------------
    const newProjectModal = document.getElementById('new-project-modal');
    const newProjectInput = document.getElementById('new-project-input');
    const newProjectError = document.getElementById('new-project-error');
    const confirmNewProjectBtn = document.getElementById('confirm-new-project');

    const instructionModal = document.getElementById('instruction-modal');
    const instructionCloseBtn = document.getElementById('instruction-close');
    const instructionModalCloseX = document.getElementById('instruction-modal-close-x');
    const instructionMessage = instructionModal.querySelector('p');
    const displayedThreadName = document.getElementById('displayed-thread-name');

    const newProjectModalCloseX = document.getElementById('new-project-modal-close-x');

    const logoutButton = document.getElementById('logout-button');
    const createNewThreadButton = document.getElementById('create-new-thread');
    const fileInput = document.getElementById('file-upload');
    const additionalUpload = document.getElementById('additional-upload');
    const imageContainer = document.getElementById('image-container');
    const uploadedImage = document.getElementById('uploaded-image');
    const ocrOutput = document.getElementById('ocr-output');
    const downloadBtn = document.getElementById('download-btn');
    const uploadMore = document.getElementById('upload-more');
    const imageNav = document.getElementById('image-nav');

    const screenOverlay = document.getElementById('screen-overlay');
    const previousThreads = document.getElementById('previous-threads');
    const threadsBar = document.getElementById('threads-bar');
    const threadsList = document.getElementById('threads-list');
    const arrowIcon = document.getElementById('arrow-icon');
    const threadsLabel = document.getElementById('previous-threads-label');

    const loadingIndicator = document.getElementById('loading-indicator');
    const loadingPercent = document.getElementById('loading-percent');

    // For the Download Modal & Progress
    const downloadModal = document.getElementById('download-modal');
    const downloadModalCloseX = document.getElementById('download-modal-close-x');
    const confirmDownloadBtn = document.getElementById('confirm-download');
    const downloadMessage = document.getElementById('downloadMessage');
    const downloadProgressSpan = document.getElementById('download-progress');

    let imageData = [];
    let currentImageIndex = -1;
    const MAX_IMAGES = 10;

    let isExpanded = false;
    let threadName = displayedThreadName.innerText.trim();
    let selectedThread = null;
    // If we detect that threadName = "No projects created yet." or empty, we lock
    let threadNameLocked = (
      threadName === '' ||
      threadName === 'No project' ||
      threadName === 'No projects created yet.'
    );

    // LOGOUT BUTTON
    if (logoutButton) {
      logoutButton.addEventListener('click', (event) => {
        event.preventDefault();
        const userConfirmed = confirm('Do you want to logout? Click "OK" for Yes, "Cancel" for No.');
        if (userConfirmed) {
          window.location.href = "{{ url_for('logout') }}";
        }
      });
    }

    // TOAST & HELPERS

    // Add a global click listener to show a toast if project name is not created
document.addEventListener('click', function(event) {
    // Define selectors for elements that should NOT trigger the toast
    const allowedSelectors = [
        '#create-new-thread',
        '#create-new-thread *',
        '#new-project-modal',
        '#new-project-modal *',
        '#instruction-modal',
        '#instruction-modal *',
        '#download-modal',
        '#download-modal *',
        // Add more selectors here if there are other elements that should be excluded
    ];

    // Check if the clicked element is within any of the allowed selectors
    const isAllowed = allowedSelectors.some(selector => event.target.closest(selector));

    // If the project name is locked and the click is not on an allowed element, show the toast
    if (threadNameLocked && !isAllowed) {
        showToast('Please create a project, using + icon on right top.', 'error');
    }
});


    function showToast(message, type = 'error', duration = 3000) {
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'fixed bottom-5 right-5 flex flex-col items-end space-y-2 z-50';
        document.body.appendChild(toastContainer);
      }

      const toast = document.createElement('div');
      let bgColorClass = 'bg-red-500'; // Default to error
      if (type === 'info') {
        bgColorClass = 'bg-blue-500';
      } else if (type === 'success') {
        bgColorClass = 'bg-green-500';
      }
      toast.className = `${bgColorClass} text-white px-4 py-2 rounded shadow-lg`;
      toast.innerText = message;
      toastContainer.appendChild(toast);

      setTimeout(() => {
        toastContainer.removeChild(toast);
        if (toastContainer.children.length === 0) {
          toastContainer.remove();
        }
      }, duration);
    }

    // -------------------------
    // ENABLE/DISABLE UPLOAD
    // -------------------------
    function enableUploadFeatures() {
      imageContainer.classList.remove('disabled');
      uploadMore.classList.remove('disabled');
      downloadBtn.classList.remove('disabled');

      imageContainer.removeAttribute('data-disabled');
      uploadMore.removeAttribute('data-disabled');
      downloadBtn.removeAttribute('data-disabled');

      imageContainer.classList.add('cursor-pointer');
      uploadMore.classList.add('cursor-pointer');
      downloadBtn.classList.add('cursor-pointer');

      // Unlock the file inputs
      fileInput.disabled = false;
      additionalUpload.disabled = false;
    }

    function disableUploadFeatures() {
      imageContainer.classList.add('disabled');
      uploadMore.classList.add('disabled');
      downloadBtn.classList.add('disabled');

      imageContainer.setAttribute('data-disabled', 'true');
      uploadMore.setAttribute('data-disabled', 'true');
      downloadBtn.setAttribute('data-disabled', 'true');

      imageContainer.classList.remove('cursor-pointer');
      uploadMore.classList.remove('cursor-pointer');
      downloadBtn.classList.remove('cursor-pointer');

      // Lock the file inputs
      fileInput.disabled = true;
      additionalUpload.disabled = true;
    }

    // Initialize by disabling if threadName is not valid
    if (threadNameLocked) {
      disableUploadFeatures();
    }

    // PROGRESS HELPER
    function updateLoadingProgress(progress) {
      if (progress === 0) {
        loadingIndicator.classList.add('hidden');
        loadingPercent.textContent = '0%';
      } else {
        loadingIndicator.classList.remove('hidden');
        loadingPercent.textContent = `${progress}%`;
      }
      if (progress === 100) {
        setTimeout(() => {
          loadingIndicator.classList.add('hidden');
        }, 1500);
      }
    }

    // CREATE NEW PROJECT - MODAL LOGIC
    if (createNewThreadButton) {
      createNewThreadButton.addEventListener('click', function(event) {
        event.preventDefault();
        event.stopPropagation();
        // Show the new-project-modal
        newProjectModal.classList.add('show');
        newProjectInput.value = '';
        newProjectError.classList.add('hidden');
        newProjectError.innerText = '';
        // Set focus to the input field
        newProjectInput.focus();
      });
    }

    if (confirmNewProjectBtn) {
      confirmNewProjectBtn.addEventListener('click', async () => {
        const typedName = newProjectInput.value.trim();
        if (!typedName) {
          newProjectError.innerText = 'Please enter a non-empty project name.';
          newProjectError.classList.remove('hidden');
          return;
        }

        try {
          const res = await fetch(`/checkThreadName?name=${encodeURIComponent(typedName)}`);
          if (!res.ok) {
            throw new Error('Error checking project name.');
          }
          const data = await res.json();
          if (data.exists) {
            newProjectError.innerText = 'Project name already exists. Please choose a new one.';
            newProjectError.classList.remove('hidden');
            return;
          }
        } catch (err) {
          console.error(err);
          newProjectError.innerText = 'An error occurred. Please try again.';
          newProjectError.classList.remove('hidden');
          return;
        }

        // Name is valid & free
        threadName = typedName;
        displayedThreadName.innerText = threadName;
        threadNameLocked = false;
        enableUploadFeatures();

        // Clear old project data
        imageData.length = 0;
        uploadMore.classList.add('hidden');
        imageNav.classList.add('hidden');
        uploadedImage.classList.add('hidden');
        uploadedImage.src = '';
        ocrOutput.innerHTML = '<p class="text-gray-500">SLD image data will appear here</p>';
        downloadBtn.classList.add('hidden');

        // Show the upload placeholder text
        const placeholder = imageContainer.querySelector('p');
        if (placeholder) {
            placeholder.classList.remove('hidden');
        }

        // Hide the modal
        newProjectModal.classList.remove('show');
        showToast(`New project "${threadName}" is ready. You can upload files now.`, 'success', 4000);
      });
    }

    // Close '×' Button for New Project Modal
    if (newProjectModalCloseX) {
      newProjectModalCloseX.addEventListener('click', () => {
        newProjectModal.classList.remove('show');
      });
    }

    // Close '×' Button for Instruction Modal
    if (instructionModalCloseX) {
      instructionModalCloseX.addEventListener('click', () => {
        instructionModal.classList.remove('show');
      });
    }

    // FILE UPLOAD & PROCESSING
    fileInput.addEventListener('change', (event) => {
      handleFileUpload(event.target.files[0]);
    });
    additionalUpload.addEventListener('change', (event) => {
      handleFileUpload(event.target.files[0], true);
    });

    // "Upload More" click
    uploadMore.addEventListener('click', () => {
      if (!threadNameLocked && threadName.length > 0) {
        // Trigger hidden file input
        additionalUpload.click();
      } else {
        showToast('Please create/open a project first.', 'error');
      }
    });

    async function handleFileUpload(file, isAdditional = false) {
      if (!file) return;

      // Double-check: if no thread name, block
      if (threadNameLocked || !threadName || threadName === 'No project' || threadName === 'No projects created yet.') {
        showToast('Please create/open a project first.', 'error');
        // Reset input so the same file can be chosen again if needed
        fileInput.value = '';
        additionalUpload.value = '';
        return;
      }

      if (imageData.length >= MAX_IMAGES) {
        alert('Maximum limit of 10 images reached');
        fileInput.value = '';
        additionalUpload.value = '';
        return;
      }

      // Step 1: Image Upload Initiation => 10%
      updateLoadingProgress(10);

      const imageSrc = URL.createObjectURL(file);
      const newIndex = imageData.length;
      imageData.push({
        image: imageSrc,
        output: 'Analysing your image....',
        thread_name: threadName
      });

      updateImageNav();
      currentImageIndex = newIndex;
      switchImage(currentImageIndex);

      if (imageData.length === 1) {
        uploadMore.classList.remove('hidden');
      }

      if (imageData.length === 1 || isAdditional) {
        uploadedImage.src = imageSrc;
        uploadedImage.classList.remove('hidden');
        const placeholder = imageContainer.querySelector('p');
        if (placeholder) placeholder.classList.add('hidden');
      }

      if (imageData.length === 1) {
        downloadBtn.classList.remove('hidden');
      }

      try {
        updateLoadingProgress(15);
        const formData = new FormData();
        formData.append('file', file);
        formData.append('thread_name', threadName);

        const response = await fetch('/upload', {
          method: 'POST',
          body: formData,
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error processing file');
        }

        // Assume GCS + OCR + Analysis => 90%
        updateLoadingProgress(90);

        const data = await response.json();
        console.log('Server response:', data);

        imageData[newIndex].output = data.structured_analysis;
        if (currentImageIndex === newIndex) {
          displayOutput(currentImageIndex);
        }

        updateLoadingProgress(100);
      } catch (error) {
        console.error(error);
        imageData[newIndex].output = 'Error processing file. Please try again.';
        if (currentImageIndex === newIndex) {
          displayOutput(currentImageIndex);
        }
        showToast(`Upload error: ${error.message}`, 'error');
        updateLoadingProgress(0);
      } finally {
        // Reset input so user can choose the same file name again later if needed
        fileInput.value = '';
        additionalUpload.value = '';
      }
    }

    // IMAGE DISPLAY & NAVIGATION
    function displayOutput(index) {
      if (index >= 0 && index < imageData.length) {
        ocrOutput.innerHTML = `
          <div>
            <h3 class="font-semibold mb-2">Structured Analysis:</h3>
            <pre class="whitespace-pre-wrap bg-white p-3 rounded-md border text-[14px] leading-normal">
${imageData[index].output}
            </pre>
          </div>
        `;
      }
    }

    function switchImage(index) {
      if (index >= 0 && index < imageData.length) {
        currentImageIndex = index;
        uploadedImage.src = imageData[index].image;
        uploadedImage.classList.remove('hidden');
        const placeholder = imageContainer.querySelector('p');
        if (placeholder) placeholder.classList.add('hidden');

        displayOutput(index);
        updateImageNav();
      }
    }

    function updateImageNav() {
      imageNav.innerHTML = '';
      if (imageData.length > 0) {
        imageNav.classList.remove('hidden');
      }

      for (let i = 0; i < imageData.length; i++) {
        const button = document.createElement('button');
        button.className =
          `relative py-2 px-3 border border-gray-300 rounded-lg
          hover:bg-gray-100
          ${i === currentImageIndex ? 'bg-gray-50' : 'bg-white'}`;

        button.innerHTML = `
          <span
            class="absolute top-0 left-0 right-0 h-[4px] bg-blue-500 rounded-t-lg
            ${i === currentImageIndex ? 'block' : 'hidden'}">
          </span>
          Image ${i + 1}
        `;
        button.onclick = () => switchImage(i);
        imageNav.appendChild(button);
      }
    }

    // DOWNLOAD BUTTON + DOWNLOAD MODAL LOGIC
    downloadBtn.onclick = async () => {
      if (!threadName || threadNameLocked || threadName === 'No project' || threadName === 'No projects created yet.') {
        showToast('Please create/open a project first.', 'error');
        return;
      }

      // Fill the modal text with the project name
      downloadMessage.innerHTML = `
        You are downloading an Excel file for the entire project:
        <span class="font-semibold text-gray-900">${threadName}</span>.
      `;

      // Show the modal
      downloadModal.classList.add('show');
    };

    if (confirmDownloadBtn) {
      confirmDownloadBtn.addEventListener('click', async () => {
        downloadModal.classList.remove('show'); // close the modal

        // 1) First, find out how many images are in this thread
        let totalImages = 0;
        try {
          const res = await fetch(`/getThreadImages?threadName=${encodeURIComponent(threadName)}`);
          if (res.ok) {
            const imagesData = await res.json();
            totalImages = imagesData.length;
          }
        } catch (err) {
          console.error('Error fetching images for progress calculation:', err);
        }

        // Show the progress span
        downloadProgressSpan.classList.remove('hidden');
        downloadProgressSpan.textContent = '0%';

        // 2) If there are no images, quick fallback
        if (totalImages === 0) {
          setDownloadProgress(0);
          showToast(`No images found in project "${threadName}"`, 'info', 4000);
          await sleep(1000);
          downloadProgressSpan.textContent = '0%';
          downloadProgressSpan.classList.add('hidden');
          return;
        }

        // 3) Calculate increment per image
        const incrementPerImage = Math.floor(100 / totalImages);
        let currentProgress = 0;

        try {
          // Simulate each image's final "analysis->Gemini->Excel prep"
          for (let i = 0; i < totalImages; i++) {
            await sleep(400);
            currentProgress += incrementPerImage;
            if (i === totalImages - 1) {
              currentProgress = Math.min(currentProgress, 90);
            }
            setDownloadProgress(currentProgress);
          }

          // 4) Finally, fetch the actual Excel file
          const downloadUrl = `/downloadAnalysis?threadName=${encodeURIComponent(threadName)}`;
          const response = await fetch(downloadUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          // 5) Finalize to 100%
          setDownloadProgress(100);

          // Do the actual file download
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const anchor = document.createElement('a');
          anchor.href = url;
          anchor.download = `${threadName}_structured_analysis.xlsx`;
          document.body.appendChild(anchor);
          anchor.click();
          document.body.removeChild(anchor);
          URL.revokeObjectURL(url);

        } catch (error) {
          console.error("Error downloading the file:", error);
          alert("Failed to download the file. Please try again.");
        } finally {
          await sleep(1200);
          downloadProgressSpan.textContent = '0%';
          downloadProgressSpan.classList.add('hidden');
        }
      });
    }

    if (downloadModalCloseX) {
      downloadModalCloseX.addEventListener('click', () => {
        downloadModal.classList.remove('show');
      });
    }

    function setDownloadProgress(value) {
      downloadProgressSpan.textContent = `${value}%`;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // PREVIOUS THREADS + Overlay logic
    threadsBar.addEventListener('click', async () => {
      if (!isExpanded) {
        await fetchThreads();
      }
      togglePreviousThreads();
    });

    function togglePreviousThreads() {
      isExpanded = !isExpanded;
      arrowIcon.classList.toggle('rotate-180', isExpanded);

      if (isExpanded) {
        previousThreads.style.height = '15cm';
        screenOverlay.classList.remove('hidden');
        threadsLabel.classList.remove('text-gray-700');
        threadsLabel.classList.add('text-white');
        arrowIcon.classList.remove('text-gray-600', 'hover:text-gray-800');
        arrowIcon.classList.add('text-white');
      } else {
        previousThreads.style.height = '1cm';
        screenOverlay.classList.add('hidden');
        threadsLabel.classList.remove('text-white');
        threadsLabel.classList.add('text-gray-700');
        arrowIcon.classList.remove('text-white');
        arrowIcon.classList.add('text-gray-600', 'hover:text-gray-800');
      }
    }

    async function fetchThreads() {
      try {
        const res = await fetch('/getThreads');
        if (!res.ok) throw new Error('Error fetching threads');
        const threadsData = await res.json();

        threadsList.innerHTML = '';
        if (!threadsData.length) {
          threadsList.innerHTML = '<li class="p-2 text-gray-500">No threads found</li>';
        } else {
          threadsData.forEach((thread) => {
            const li = document.createElement('li');
            li.className = 'p-2 border border-gray-200 rounded hover:bg-gray-100 cursor-pointer';
            li.textContent = thread.thread_name || 'Unnamed Thread';

            if (selectedThread && thread.thread_name === selectedThread) {
              li.classList.add('selected-thread');
            }
            threadsList.appendChild(li);
          });
        }
      } catch (err) {
        console.error(err);
        alert('Failed to load threads');
      }
    }

    threadsList.addEventListener('click', async (event) => {
      if (!event.target.matches('li')) return;
      const chosenThread = event.target.innerText.trim();
      console.log('User clicked on:', chosenThread);
      highlightSelectedThread(event.target);
      togglePreviousThreads();
      await loadThreadImages(chosenThread);
    });

    function highlightSelectedThread(selectedElement) {
      const allThreads = threadsList.querySelectorAll('li');
      allThreads.forEach(li => li.classList.remove('selected-thread'));
      selectedElement.classList.add('selected-thread');
      selectedThread = selectedElement.textContent.trim();
    }

    // HELPER: LOAD IMAGES FOR A GIVEN THREAD
    async function loadThreadImages(chosenThread) {
      try {
        const res = await fetch(`/getThreadImages?threadName=${encodeURIComponent(chosenThread)}`);
        if (!res.ok) throw new Error(`Error fetching images for thread: ${chosenThread}`);
        const imagesData = await res.json();

        imageData.length = 0;
        currentImageIndex = -1;

        if (!imagesData.length) {
          uploadMore.classList.add('hidden');
          threadName = chosenThread;
          displayedThreadName.innerText = chosenThread;
          threadNameLocked = false;
          enableUploadFeatures();

          uploadedImage.classList.add('hidden');
          uploadedImage.src = '';
          ocrOutput.innerHTML = '<p class="text-gray-500">No images found in this thread</p>';
          downloadBtn.classList.add('hidden');
          imageNav.classList.add('hidden');
          return;
        }

        imagesData.forEach((imgInfo) => {
          imageData.push({
            image: imgInfo.image_url || '',
            output: imgInfo.structured_analysis || '',
            thread_name: chosenThread,
            file_name: imgInfo.file_name
          });
        });

        threadName = chosenThread;
        displayedThreadName.innerText = chosenThread;
        threadNameLocked = false;
        enableUploadFeatures();

        if (imageData.length) {
          updateImageNav();
          currentImageIndex = 0;
          switchImage(0);
          uploadMore.classList.remove('hidden');
          downloadBtn.classList.remove('hidden');
        }
      } catch (error) {
        console.error(error);
        alert('Error loading thread images. See console for details.');
      }
    }

    // KEYBOARD INTERACTIONS FOR MODALS
    document.addEventListener('keydown', function(event) {
      // If Instruction Modal is open
      if (instructionModal.classList.contains('show')) {
        if (event.key === 'Enter') {
          event.preventDefault();
          instructionCloseBtn.click();
        } else if (event.key === 'Escape') {
          event.preventDefault();
          instructionCloseBtn.click();
        }
      }

      // If New Project Modal is open
      if (newProjectModal.classList.contains('show')) {
        if (event.key === 'Enter') {
          event.preventDefault();
          confirmNewProjectBtn.click();
        } else if (event.key === 'Escape') {
          event.preventDefault();
          newProjectModal.classList.remove('show');
        }
      }

      // If Download Modal is open
      if (downloadModal.classList.contains('show')) {
        if (event.key === 'Escape') {
          event.preventDefault();
          downloadModal.classList.remove('show');
        }
      }
    });

    // ON DOM LOADED: if lastThread is present, auto-load
    const lastThread = "{{ last_thread or '' }}";
    document.addEventListener('DOMContentLoaded', async () => {
      if (lastThread) {
        // Show the instruction modal with custom message
        instructionMessage.innerHTML = `
          You were working on
          <span style="color: #008000;">${lastThread}</span>.
          Please click on 'New Project' to start a new project.
        `;
        instructionModal.classList.add('show');

        // Automatically load images for that thread
        await loadThreadImages(lastThread);
      } else {
        // If no lastThread, show default message
        instructionMessage.textContent =
          "To begin, please create or open a project using the '+' icon button on right top or 'Previous Projects' below.";
        instructionModal.classList.add('show');

        // Ensure disabled state if no project
        disableUploadFeatures();
      }

      if (instructionCloseBtn) {
        instructionCloseBtn.addEventListener('click', () => {
          instructionModal.classList.remove('show');
        });
      }
    });
  </script>
</body>
</html>
