<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Circuit Diagram Analyzer</title>

  <!-- Tailwind CSS -->
  <link href="{{ url_for('static', filename='css/tailwind-output.css') }}" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Disabled State */
    .disabled {
      opacity: 0.6;
      cursor: not-allowed !important;
    }
    .selected-thread {
      background-color: #AFE1AF !important;
      border-color: #badbcc !important;
    }

    /* Loading Circle */
    .loading-circle {
      border: 4px solid #e2e2e2;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Modal Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #instruction-modal,
    #new-project-modal,
    #download-modal,
    #delete-modal,
    #threads-modal {
      display: none;
    }
    #instruction-modal.show,
    #new-project-modal.show,
    #download-modal.show,
    #delete-modal.show,
    #threads-modal.show {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Error Message */
    .error-message {
      color: red;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    /* Hover Effect for Table Rows */
    .hover-bg-gray:hover {
      background-color: #f0f0f0;
    }
    .selected-row {
      background-color: #f0f0f0 !important;
    }

    /* Editable Input Container */
    .edit-input-container {
      position: relative;
      display: block;
      border: none;
      box-sizing: border-box;
      overflow: hidden;
      width: 100%;           /* Let it grow horizontally */
      min-height: 2rem;      /* A reasonable minimum height */
    }

    .edit-input-container .edit-input {
      min-height: 2rem;
      width: 100%;
      border: none;
      padding: 8px;
      box-sizing: border-box;
      display: block;
      position: relative;
      z-index: 1;
      resize: vertical;      /* Allow vertical resizing */
      overflow-y: auto;      /* Only show scrollbar if content exceeds */
    }

    .edit-input-container.editable .edit-input {
      background-color: #ffffff;
      border: 1px solid #ccc;
    }

    .edit-input.read-only {
      pointer-events: none;
      background-color: transparent;
    }

    .edit-input-container:hover {
      background-color: #f0f0f0;
    }
    .edit-input-container.editable:hover {
      background-color: transparent;
    }

    /* --- Magnifier container --- */
.img-magnifier-container {
  position: relative;
}

/* --- Magnifying glass (the rectangular lens) --- */
.img-magnifier-glass {
  position: absolute;
  border: 3px solid #000;
  border-radius: 0;              /* Rectangle shape */
  width: 300px;                   /* ~3 inches at 96 DPI */
  height: 200px;                  /* ~2 inches at 96 DPI */
  z-index: 100;                   /* Ensure it’s on top */
  display: none;                  /* Hidden by default */
  cursor: none;                   /* Hide default cursor inside lens */
  pointer-events: none;           /* Allow mouse events to pass through lens */
  background-repeat: no-repeat;
  background-size: 200% 200%;    /* Adjust based on zoom */
  /* You can adjust the background size dynamically via JS */
}

/* 'X' Button inside the lens */
.img-magnifier-glass .close-btn {
  position: absolute;
  top: -10px;
  right: -10px;
  width: 20px;
  height: 20px;
  background: #e11d48;            /* Red background */
  color: #fff;
  font-size: 14px;
  text-align: center;
  line-height: 20px;
  border-radius: 50%;
  cursor: pointer;                /* Pointer cursor for the close button */
  pointer-events: auto;           /* Enable pointer events for the close button */
  display: none;                  /* Hidden unless pinned */
}

/* Show 'X' when pinned */
.img-magnifier-glass.pinned .close-btn {
  display: block;
}
/* --- Magnifying glass (the rectangular lens) --- */
.img-magnifier-glass {
  position: absolute;
  border: 3px solid #000;
  border-radius: 0;              /* Rectangle shape */
  width: 300px;                   /* ~3 inches at 96 DPI */
  height: 200px;                  /* ~2 inches at 96 DPI */
  z-index: 100;                   /* Ensure it’s on top */
  display: none;                  /* Hidden by default */
  cursor: none;                   /* Hide default cursor inside lens */
  pointer-events: none;           /* Allow mouse events to pass through lens */
  background-repeat: no-repeat;
  background-size: 200% 200%;    /* Adjust based on zoom */
  /* You can adjust the background size dynamically via JS */
}

/* 'X' Button inside the lens */
.img-magnifier-glass .close-btn {
  position: absolute;
  top: -10px;
  right: -10px;
  width: 20px;
  height: 20px;
  background: #e11d48;            /* Red background */
  color: #fff;
  font-size: 14px;
  text-align: center;
  line-height: 20px;
  border-radius: 50%;
  cursor: pointer;                /* Pointer cursor for the close button */
  pointer-events: auto;           /* Enable pointer events for the close button */
  display: none;                  /* Hidden unless pinned */
}

/* Show 'X' when pinned */
.img-magnifier-glass.pinned .close-btn {
  display: block;
}


  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-messages" class="fixed top-4 right-4 z-50 flex flex-col space-y-2">
            {% for category, message in messages %}
                {% if category != 'login_success' %}
                    <div class="px-4 py-2 rounded shadow-lg text-white
                        {% if category == 'logout_success' %}
                            bg-blue-500
                        {% elif category == 'error' %}
                            bg-red-500
                        {% else %}
                            bg-gray-500
                        {% endif %}
                    ">
                        {{ message }}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <script>
            // Automatically hide flash messages after 5 seconds
            setTimeout(() => {
                const flashContainer = document.getElementById('flash-messages');
                if (flashContainer) {
                    flashContainer.style.display = 'none';
                }
            }, 5000);
        </script>
    {% endif %}
{% endwith %}

<!-- MODALS SECTION -->
<!-- Instruction Modal -->
<div id="instruction-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full relative">
    <button id="instruction-modal-close-x" class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 focus:outline-none w-5 h-5 flex items-center justify-center" aria-label="Close Instruction Modal">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <h2 class="text-xl font-semibold mb-4">Welcome!</h2>
    <p class="text-gray-700 mb-6">To begin, please enter the project name in the text field above.</p>
    <div class="flex justify-end">
      <button id="instruction-close"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
        I Understand
      </button>
    </div>
  </div>
</div>

<!-- New Project Modal -->
<div id="new-project-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full relative">
    <button id="new-project-modal-close-x"
            class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 focus:outline-none w-5 h-5 flex items-center justify-center"
            aria-label="Close New Project Modal">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <h2 class="text-xl font-semibold mb-4">Create New Project</h2>
    <label class="block mb-2 text-gray-700">Project Name:</label>
    <input type="text" id="new-project-input"
           class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
           placeholder="Enter new project name..." />
    <p id="new-project-error" class="error-message hidden"></p>
    <div class="flex justify-end mt-4">
      <button id="confirm-new-project"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
        Confirm
      </button>
    </div>
  </div>
</div>

<!-- Download Modal -->
<div id="download-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full relative">
    <button id="download-modal-close-x"
            class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 focus:outline-none w-5 h-5 flex items-center justify-center"
            aria-label="Close Download Modal">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <h2 class="text-xl font-semibold mb-4">Download Excel</h2>
    <p id="downloadMessage" class="text-gray-700 mb-6"></p>
    <div class="flex justify-end">
      <button id="confirm-download"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
        Confirm Download
      </button>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full relative">
    <button id="delete-modal-close-x"
            class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 focus:outline-none w-5 h-5 flex items-center justify-center"
            aria-label="Close Delete Modal">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
           viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <h2 class="text-xl font-semibold mb-4">Confirm Delete</h2>
    <p id="delete-message" class="text-gray-700 mb-6">Are you sure you want to delete this row?</p>
    <div class="flex justify-end mt-4 gap-2">
      <button id="cancel-delete"
              class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition">
        Cancel
      </button>
      <button id="confirm-delete"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Threads (Previous Projects) Modal -->
<div id="threads-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50" role="dialog" aria-modal="true" aria-labelledby="threads-modal-title">
  <div class="bg-white rounded-lg shadow-lg p-6 relative flex flex-col" style="width: 5in; height: 4in;">
    <!-- Close Button -->
    <button id="threads-modal-close-x"
            class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 focus:outline-none w-5 h-5 flex items-center justify-center"
            aria-label="Close Threads Modal">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    
    <!-- Modal Title -->
    <h2 id="threads-modal-title" class="text-xl font-semibold mb-4">Previous Projects</h2>
    
    <!-- Threads List -->
    <ul id="threads-list" class="space-y-2 custom-scrollbar overflow-auto border p-2 rounded-md flex-grow">
      <!-- Dynamically populated by fetchThreads() -->
    </ul>
  </div>
</div>



<!-- TOP BAR -->
<header class="bg-white shadow px-4 py-3 flex justify-between items-center">
  <div class="flex items-center gap-3">
    <h1 class="text-md md:text-lg font-bold text-gray-700">
      Current Project:
      <span id="displayed-thread-name" class="text-blue-700">
        {{ last_thread if last_thread else 'No projects created yet.' }}
      </span>
    </h1>

    <!-- Button to open the threads modal (previous projects) -->
    <button id="open-threads-button"
            class="bg-gray-200 text-gray-700 px-2 py-1 rounded-lg hover:bg-gray-300 transition text-sm"
            title="Open existing projects">
      Open Projects
    </button>

    <!-- Create New Thread -->
    <button id="create-new-thread"
            class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition flex items-center gap-1 text-sm"
            title="Create new project">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
           viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 4v16m8-8H4" />
      </svg>
      New Project
    </button>
  </div>

  <div class="flex items-center gap-3">
    <span class="text-gray-700 hidden md:inline-block text-sm">
      Logged in as: <strong>{{ username }}</strong>
    </span>
    <button id="logout-button" class="bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600 transition text-sm">
      Logout
    </button>
  </div>
</header>

<!-- MAIN FULL-PAGE CONTENT -->
<div class="flex flex-col h-[calc(100vh-4rem)]">

  <!-- Optional: an area to show download progress or any top info -->
  <div class="bg-gray-50 px-4 py-2 flex items-center justify-between border-b">
    <div class="text-sm text-gray-600">
      <span>Project:</span>
      <span id="analysis-project-label" class="text-green-600 font-bold ml-1"></span>
    </div>
    <!-- Download + progress -->
    <div class="flex items-center gap-2">
      <button id="download-btn"
              class="bg-green-600 text-white px-3 py-1 rounded shadow hover:bg-green-700 hidden disabled"
              data-disabled="true"
              title="Download is available once analysis is complete.">
        Download
      </button>
      <span id="download-progress" class="text-sm font-medium text-gray-700 hidden">0%</span>
    </div>
  </div>

  <!-- TWO-COLUMN LAYOUT: IMAGE LEFT, DATA RIGHT (FILL THE REST OF THE PAGE) -->
  <div class="flex flex-grow overflow-hidden">
    <!-- LEFT: IMAGE UPLOAD & NAV -->
    <section class="w-1/2 bg-white p-4 flex flex-col relative overflow-auto">
     <!-- Your existing label or container -->
     <div id="image-container"
     class="flex-1 flex flex-col justify-center items-center border-2 border-dashed 
            border-gray-300 rounded-lg p-2 bg-gray-100 disabled"
     data-disabled="true"
     title="Create or open a project to enable image upload.">
  
  <!-- The new .img-magnifier-container wrapper -->
  <div id="magnifier-wrapper" class="img-magnifier-container relative hidden">
    <img id="uploaded-image" 
         class="max-h-full max-w-full object-contain rounded-lg" 
         alt="Uploaded SLD" 
    />
  </div>
  
  <!-- Clickable Label for Upload -->
  <label for="file-upload" class="cursor-pointer">
    <p class="text-gray-500 text-center">Click here to upload an image</p>
  </label>
  
  <input type="file" id="file-upload" name="file" accept=".png,.jpg,.jpeg" class="hidden" disabled />
</div>



      <!-- Upload More Button -->
      <div id="upload-more"
           class="hidden absolute bottom-2 right-4 flex items-center gap-1 cursor-pointer text-gray-600 hover:text-gray-900 disabled"
           data-disabled="true"
           title="Create or open a project to upload more images.">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round"
             class="w-5 h-5">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span class="text-sm">Upload more</span>
        <input type="file" id="additional-upload" accept=".png,.jpg,.jpeg" class="hidden" disabled />
      </div>

      <!-- THUMBNAILS / IMAGE NAV -->
      <div id="image-nav" class="hidden mt-4 flex gap-2 flex-wrap"></div>
    </section>

    <!-- RIGHT: SLD DATA -->
    <section class="w-1/2 bg-white p-4 flex flex-col overflow-auto border-l border-gray-200">
      <!-- Action Bar -->
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-bold text-gray-700">SLD Data</h2>
        <div class="flex items-center gap-2">
          <button id="save-btn"
                  class="bg-white text-gray-700 hover:bg-gray-200 transition rounded-full p-1 disabled"
                  data-disabled="true"
                  title="Save changes"
                  style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M5 13l4 4L19 7" />
            </svg>
          </button>
          <div class="relative inline-block text-left">
            <button id="dropdown-btn"
                    class="bg-white text-gray-600 hover:text-gray-800 rounded-full p-1 disabled"
                    data-disabled="true"
                    title="Options"
                    style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                   viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M5 12h.01M12 12h.01M19 12h.01
                         M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0
                         1 1 0 012 0zm7 0 a1 1 0 11-2 0 1 1 0 012 0z" />
              </svg>
            </button>
            <div id="dropdown-menu"
                 class="absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 hidden"
                 style="z-index: 1000;">
              <div class="py-1">
                <button id="add-row-btn" class="block px-4 py-2 w-full text-left text-gray-700 hover:bg-gray-100">Add Row</button>
                <button id="edit-row-btn" class="block px-4 py-2 w-full text-left text-gray-700 hover:bg-gray-100">Edit Row</button>
                <button id="delete-row-btn" class="block px-4 py-2 w-full text-left text-gray-700 hover:bg-gray-100">Delete Row</button>
              </div>
            </div>
          </div>
          <div id="loading-indicator" class="hidden flex items-center">
            <div class="loading-circle"></div>
            <span id="loading-percent" class="text-sm font-medium text-gray-700">0%</span>
          </div>
        </div>
      </div>

      <!-- OCR Output -->
      <div class="relative flex-1">
        <div id="ocr-output" class="absolute inset-0 bg-gray-100 border rounded-lg p-3 overflow-y-auto custom-scrollbar">
          <p class="text-gray-500">SLD image data will appear here</p>
        </div>
      </div>
    </section>
  </div>
</div>
<!-- MAIN JS LOGIC -->
<script>
  // -----------------------------------------------------
  // GLOBAL VARIABLES & DOM REFERENCES
  // -----------------------------------------------------
  const newProjectModal = document.getElementById('new-project-modal');
  const newProjectInput = document.getElementById('new-project-input');
  const newProjectError = document.getElementById('new-project-error');
  const confirmNewProjectBtn = document.getElementById('confirm-new-project');

  const instructionModal = document.getElementById('instruction-modal');
  const instructionCloseBtn = document.getElementById('instruction-close');
  const instructionModalCloseX = document.getElementById('instruction-modal-close-x');
  const instructionMessage = instructionModal.querySelector('p');

  const newProjectModalCloseX = document.getElementById('new-project-modal-close-x');

  const logoutButton = document.getElementById('logout-button');
  const createNewThreadButton = document.getElementById('create-new-thread');
  const fileInput = document.getElementById('file-upload');
  const additionalUpload = document.getElementById('additional-upload');
  const imageContainer = document.getElementById('image-container');
  const uploadedImage = document.getElementById('uploaded-image');
  const ocrOutput = document.getElementById('ocr-output');
  const downloadBtn = document.getElementById('download-btn');
  const uploadMore = document.getElementById('upload-more');
  const imageNav = document.getElementById('image-nav');

  const displayedThreadName = document.getElementById('displayed-thread-name');
  const analysisProjectLabel = document.getElementById('analysis-project-label');

  // Row actions
  const saveBtn = document.getElementById('save-btn');
  const dropdownBtn = document.getElementById('dropdown-btn');
  const dropdownMenu = document.getElementById('dropdown-menu');
  const addRowBtn = document.getElementById('add-row-btn');
  const editRowBtn = document.getElementById('edit-row-btn');
  const deleteRowBtn = document.getElementById('delete-row-btn');

  // Delete modal
  const deleteModal = document.getElementById('delete-modal');
  const confirmDeleteBtn = document.getElementById('confirm-delete');
  const cancelDeleteBtn = document.getElementById('cancel-delete');
  const deleteModalCloseX = document.getElementById('delete-modal-close-x');

  // Threads (previous projects) modal
  const threadsModal = document.getElementById('threads-modal');
  const threadsModalCloseX = document.getElementById('threads-modal-close-x');
  const threadsList = document.getElementById('threads-list');
  const openThreadsButton = document.getElementById('open-threads-button');

  const loadingIndicator = document.getElementById('loading-indicator');
  const loadingPercent = document.getElementById('loading-percent');

  // Download modal
  const downloadModal = document.getElementById('download-modal');
  const downloadModalCloseX = document.getElementById('download-modal-close-x');
  const confirmDownloadBtn = document.getElementById('confirm-download');
  const downloadMessage = document.getElementById('downloadMessage');
  const downloadProgressSpan = document.getElementById('download-progress');

  let imageData = [];
  let currentImageIndex = -1;
  const MAX_IMAGES = 15;

  let selectedThread = null;
  let threadName = displayedThreadName.innerText.trim();
  let threadNameLocked = (
    threadName === '' ||
    threadName === 'No project' ||
    threadName === 'No projects created yet.'
  );

  let selectedRow = null;
  let editMode = false;
  let deleteActive = false;

  // LOGOUT BUTTON
  if (logoutButton) {
    logoutButton.addEventListener('click', (event) => {
      event.preventDefault();
      const userConfirmed = confirm('Do you want to logout? Click "OK" for Yes, "Cancel" for No.');
      if (userConfirmed) {
        window.location.href = "{{ url_for('logout') }}";
      }
    });
  }

  // -------------------------
  // TOAST / HELPER
  // -------------------------
  function showToast(message, type = 'error', duration = 3000) {
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.className = 'fixed bottom-5 right-5 flex flex-col items-end space-y-2 z-50';
      document.body.appendChild(toastContainer);
    }

    const toast = document.createElement('div');
    let bgColorClass = 'bg-red-500'; // Default to error
    if (type === 'info') {
      bgColorClass = 'bg-blue-500';
    } else if (type === 'success') {
      bgColorClass = 'bg-green-500';
    }
    toast.className = `${bgColorClass} text-white px-4 py-2 rounded shadow-lg`;
    toast.innerText = message;
    toastContainer.appendChild(toast);

    setTimeout(() => {
      toastContainer.removeChild(toast);
      if (toastContainer.children.length === 0) {
        toastContainer.remove();
      }
    }, duration);
  }

  // Show a toast if project name is locked and user clicks outside certain areas
  document.addEventListener('click', function(event) {
    const allowedSelectors = [
      '#create-new-thread',
      '#create-new-thread *',
      '#open-threads-button',
      '#threads-modal',
      '#threads-modal *',
      '#new-project-modal',
      '#new-project-modal *',
      '#instruction-modal',
      '#instruction-modal *',
      '#download-modal',
      '#download-modal *',
      '#dropdown-menu',
      '#dropdown-menu *',
      '#delete-modal',
      '#delete-modal *'
    ];
    const isAllowed = allowedSelectors.some(selector => event.target.closest(selector));

    if (threadNameLocked && !isAllowed) {
      showToast('Please create a project or open an existing one.', 'error');
    }
  });

  // -------------------------
  // ENABLE/DISABLE UPLOAD
  // -------------------------
  function enableUploadFeatures() {
    imageContainer.classList.remove('disabled');
    uploadMore.classList.remove('disabled');
    downloadBtn.classList.remove('disabled');
    saveBtn.classList.remove('disabled');
    dropdownBtn.classList.remove('disabled');

    imageContainer.removeAttribute('data-disabled');
    uploadMore.removeAttribute('data-disabled');
    downloadBtn.removeAttribute('data-disabled');
    saveBtn.removeAttribute('data-disabled');
    dropdownBtn.removeAttribute('data-disabled');

    imageContainer.classList.add('cursor-pointer');
    uploadMore.classList.add('cursor-pointer');
    downloadBtn.classList.add('cursor-pointer');
    saveBtn.classList.add('cursor-pointer');
    dropdownBtn.classList.add('cursor-pointer');

    // Unlock file inputs
    fileInput.disabled = false;
    additionalUpload.disabled = false;
  }

  function disableUploadFeatures() {
    imageContainer.classList.add('disabled');
    uploadMore.classList.add('disabled');
    downloadBtn.classList.add('disabled');
    saveBtn.classList.add('disabled');
    dropdownBtn.classList.add('disabled');

    imageContainer.setAttribute('data-disabled', 'true');
    uploadMore.setAttribute('data-disabled', 'true');
    downloadBtn.setAttribute('data-disabled', 'true');
    saveBtn.setAttribute('data-disabled', 'true');
    dropdownBtn.setAttribute('data-disabled', 'true');

    imageContainer.classList.remove('cursor-pointer');
    uploadMore.classList.remove('cursor-pointer');
    downloadBtn.classList.remove('cursor-pointer');
    saveBtn.classList.remove('cursor-pointer');
    dropdownBtn.classList.remove('cursor-pointer');

    // Lock file inputs
    fileInput.disabled = true;
    additionalUpload.disabled = true;
  }

  if (threadNameLocked) {
    disableUploadFeatures();
  }

  // PROGRESS HELPER
  function updateLoadingProgress(progress) {
    if (progress === 0) {
      loadingIndicator.classList.add('hidden');
      loadingPercent.textContent = '0%';
    } else {
      loadingIndicator.classList.remove('hidden');
      loadingPercent.textContent = `${progress}%`;
    }
    if (progress === 100) {
      setTimeout(() => {
        loadingIndicator.classList.add('hidden');
      }, 1500);
    }
  }

  // -------------------------
  // CREATE NEW PROJECT - MODAL
  // -------------------------
  if (createNewThreadButton) {
    createNewThreadButton.addEventListener('click', (event) => {
      event.preventDefault();
      newProjectModal.classList.add('show');
      newProjectInput.value = '';
      newProjectError.classList.add('hidden');
      newProjectError.innerText = '';
      newProjectInput.focus();
    });
  }

  if (confirmNewProjectBtn) {
    confirmNewProjectBtn.addEventListener('click', async () => {
      const typedName = newProjectInput.value.trim();
      if (!typedName) {
        newProjectError.innerText = 'Please enter a non-empty project name.';
        newProjectError.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch(`/checkThreadName?name=${encodeURIComponent(typedName)}`);
        if (!res.ok) {
          throw new Error('Error checking project name.');
        }
        const data = await res.json();
        if (data.exists) {
          newProjectError.innerText = 'Project name already exists. Please choose a new one.';
          newProjectError.classList.remove('hidden');
          return;
        }
      } catch (err) {
        console.error(err);
        newProjectError.innerText = 'An error occurred. Please try again.';
        newProjectError.classList.remove('hidden');
        return;
      }

      // Valid & free
      threadName = typedName;
      displayedThreadName.innerText = threadName;
      analysisProjectLabel.textContent = threadName;
      threadNameLocked = false;
      enableUploadFeatures();

      // Clear old data
      imageData.length = 0;
      uploadMore.classList.add('hidden');
      imageNav.classList.add('hidden');
      uploadedImage.classList.add('hidden');
      uploadedImage.src = '';
      ocrOutput.innerHTML = '<p class="text-gray-500">SLD image data will appear here</p>';
      downloadBtn.classList.add('hidden');

      const placeholder = imageContainer.querySelector('p');
      if (placeholder) {
        placeholder.classList.remove('hidden');
      }
      newProjectModal.classList.remove('show');
      showToast(`New project "${threadName}" is ready. You can upload files now.`, 'success', 4000);

      // Refresh the list so it shows up in the threads modal
      await fetchThreads();
    });
  }

  if (newProjectModalCloseX) {
    newProjectModalCloseX.addEventListener('click', () => {
      newProjectModal.classList.remove('show');
    });
  }

  // -------------------------
  // INSTRUCTION MODAL
  // -------------------------
  if (instructionModalCloseX) {
    instructionModalCloseX.addEventListener('click', () => {
      instructionModal.classList.remove('show');
    });
  }

  // -------------------------
  // FILE UPLOAD & PROCESSING
  // -------------------------
  fileInput.addEventListener('change', (event) => {
    handleFileUpload(event.target.files[0]);
  });
  additionalUpload.addEventListener('change', (event) => {
    handleFileUpload(event.target.files[0], true);
  });

  uploadMore.addEventListener('click', () => {
    if (!threadNameLocked && threadName.length > 0) {
      additionalUpload.click();
    } else {
      showToast('Please create or open a project first.', 'error');
    }
  });

  async function handleFileUpload(file, isAdditional = false) {
    if (!file) return;

    if (threadNameLocked) {
      showToast('Please create/open a project first.', 'error');
      fileInput.value = '';
      additionalUpload.value = '';
      return;
    }

    if (imageData.length >= MAX_IMAGES) {
  alert(`Maximum limit of ${MAX_IMAGES} images reached. Create a new project.`);
  fileInput.value = '';
  additionalUpload.value = '';
  return;
}


    updateLoadingProgress(10);

    const imageSrc = URL.createObjectURL(file);
    const newIndex = imageData.length;
    imageData.push({
      image: imageSrc,
      output: 'Analyzing image ...',
      thread_name: threadName,
      file_name: file.name
    });

    updateImageNav();
    currentImageIndex = newIndex;
    switchImage(currentImageIndex);

    if (imageData.length === 1) {
      uploadMore.classList.remove('hidden');
    }
    if (imageData.length === 1 || isAdditional) {
      uploadedImage.src = imageSrc;
      uploadedImage.classList.remove('hidden');
      const placeholder = imageContainer.querySelector('p');
      if (placeholder) placeholder.classList.add('hidden');
    }
    if (imageData.length === 1) {
      downloadBtn.classList.remove('hidden');
    }

    try {
      updateLoadingProgress(15);
      const formData = new FormData();
      formData.append('file', file);
      formData.append('thread_name', threadName);

      const response = await fetch('/upload', {
        method: 'POST',
        body: formData,
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Error processing file');
      }

      updateLoadingProgress(90);
      const data = await response.json();
      console.log('Server response:', data);

      imageData[newIndex].output = data.structured_analysis;
      if (currentImageIndex === newIndex) {
        displayOutput(currentImageIndex);
      }
      updateLoadingProgress(100);

    } catch (error) {
      console.error(error);
      imageData[newIndex].output = 'Error processing file. Please try again.';
      if (currentImageIndex === newIndex) {
        displayOutput(currentImageIndex);
      }
      showToast(`Upload error: ${error.message}`, 'error');
      updateLoadingProgress(0);
    } finally {
      fileInput.value = '';
      additionalUpload.value = '';
    }
  }

  function switchImage(index) {
  if (index >= 0 && index < imageData.length) {
    currentImageIndex = index;
    uploadedImage.src = imageData[index].image;
    uploadedImage.classList.remove('hidden');

    // Show the magnifier wrapper
    document.getElementById('magnifier-wrapper').classList.remove('hidden');

    // Ensure the image is loaded before initializing magnify
    if (uploadedImage.complete) {
      magnify("uploaded-image", 2); // Adjust zoom level as desired
    } else {
      uploadedImage.onload = () => {
        magnify("uploaded-image", 2); // Adjust zoom level as desired
      };
    }

    const placeholder = imageContainer.querySelector('p');
    if (placeholder) placeholder.classList.add('hidden');
    displayOutput(index);
    updateImageNav();
  }
}


  function updateImageNav() {
    imageNav.innerHTML = '';
    if (imageData.length > 0) {
      imageNav.classList.remove('hidden');
    }

    for (let i = 0; i < imageData.length; i++) {
      const button = document.createElement('button');
      button.className = `
        relative py-2 px-3 border border-gray-300 rounded-lg
        hover:bg-gray-100
        ${i === currentImageIndex ? 'bg-gray-50' : 'bg-white'}
      `;
      button.innerHTML = `
        <span
          class="absolute top-0 left-0 right-0 h-[4px] bg-blue-500 rounded-t-lg
          ${i === currentImageIndex ? 'block' : 'hidden'}">
        </span>
        Image ${i + 1}
      `;
      button.onclick = () => switchImage(i);
      imageNav.appendChild(button);
    }
  }

  function displayOutput(index) {
    if (index >= 0 && index < imageData.length) {
      const rawJsonString = imageData[index].output;
      let parsedData = {};
      let rows = [];
      let additionalNotes = [];
      let title = 'No Title Found';

      // Attempt to parse the analysis JSON
      try {
        parsedData = JSON.parse(rawJsonString);
        rows = parsedData.rows || [];
        additionalNotes = parsedData.additional_notes || [];
        if (typeof parsedData.title === 'string' && parsedData.title.trim().length > 0) {
          title = parsedData.title.trim();
        }
      } catch (err) {
        // If JSON parse fails, display the raw text in a nicer code block
        ocrOutput.innerHTML = `
          <div class="p-4 bg-white border rounded-md shadow-sm">
            <h3 class="font-semibold mb-2 text-gray-800">Structured Analysis (Processing)</h3>
            <pre class="whitespace-pre-wrap bg-gray-50 p-3 rounded-md border text-sm leading-normal text-gray-800 overflow-x-auto">
${rawJsonString}
            </pre>
          </div>
        `;
        return;
      }

     if (rows.length === 0) {
            ocrOutput.innerHTML = `
                <div class="p-4 bg-white border rounded-md shadow-sm">
                    <h3 class="font-semibold mb-2 text-gray-800">Structured Analysis</h3>
                     <p>No data rows available to display from the JSON</p>
                </div>
            `;
             return;
        }
      // Build our table rows
      let tableRows = rows.map((row, rowIndex) => {
        return `
          <tr data-row-index="${rowIndex}" class="hover-bg-gray">
            <td class="px-4 py-2 border border-gray-300">
              <div class="edit-input-container">
                <textarea data-field="serial_number" class="edit-input read-only">${row.serial_number ?? ""}</textarea>
              </div>
            </td>
            <td class="px-4 py-2 border border-gray-300">
              <div class="edit-input-container">
                <textarea data-field="name" class="edit-input read-only">${row.name ?? ""}</textarea>
              </div>
            </td>
            <td class="px-4 py-2 border border-gray-300">
              <div class="edit-input-container">
                <textarea data-field="quantity" class="edit-input read-only">${row.quantity ?? ""}</textarea>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      // Construct a nicer Tailwind-styled table
      const tableHtml = `
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-gray-700 border-collapse">
            <thead class="bg-gray-200 text-gray-700">
              <tr>
                <th class="px-4 py-2 border border-gray-300">Serial Number</th>
                <th class="px-4 py-2 border border-gray-300">Name</th>
                <th class="px-4 py-2 border border-gray-300">Quantity</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        </div>
      `;

      // Additional notes
      let notesHtml = "";
      if (additionalNotes.length > 0) {
        notesHtml = `
          <div class="mt-4">
            <h3 class='font-semibold mb-2 text-gray-800'>Additional Notes</h3>
            <ul class="list-disc list-inside text-sm text-gray-700">
              ${additionalNotes.map(note => `<li>${note}</li>`).join("")}
            </ul>
          </div>
        `;
      }

      // Final structure: card with Title, Table, and Additional Notes
      ocrOutput.innerHTML = `
        <div class="p-4 bg-white border rounded-md shadow-sm space-y-4">
          <h3 class="text-lg font-bold text-gray-800">Title: ${title}</h3>
          <div>
            <h3 class="font-semibold text-gray-700 mb-2">Structured Analysis</h3>
            ${tableHtml}
          </div>
          ${notesHtml}
        </div>
      `;

      // If currently in edit mode, remove read-only from inputs
      if (editMode) {
        toggleRowEditMode(true);
      } else {
        toggleRowEditMode(false);
      }
    }
  }

  function toggleRowEditMode(enabled) {
    const containers = ocrOutput.querySelectorAll('.edit-input-container');
    containers.forEach(container => {
      const input = container.querySelector('.edit-input');
      if (enabled) {
        container.classList.add('editable');
        input.classList.remove('read-only');
        input.removeAttribute('readonly');
        input.style.pointerEvents = 'auto';
      } else {
        container.classList.remove('editable');
        input.classList.add('read-only');
        input.setAttribute('readonly', true);
        input.style.pointerEvents = 'none';
      }
    });
  }

  // -------------------------
  // DROPDOWN MENU HANDLERS
  // -------------------------
  dropdownBtn.addEventListener('click', (event) => {
    event.stopPropagation();
    dropdownMenu.classList.toggle('hidden');
  });

  document.addEventListener('click', (event) => {
    if (!event.target.closest('#dropdown-menu') && !event.target.closest('#dropdown-btn')) {
      dropdownMenu.classList.add('hidden');
    }
  });

  // ADD ROW
  addRowBtn.addEventListener('click', () => {
    dropdownMenu.classList.add('hidden');
    if (!imageData[currentImageIndex]) {
      showToast("No active image to add row to.", 'error');
      return;
    }
    let rawJsonString = imageData[currentImageIndex].output;
    let parsedData;
    try {
      parsedData = JSON.parse(rawJsonString);
    } catch (err) {
      console.error("Invalid JSON while adding row:", err);
      showToast("Current image data is not valid JSON.", 'error');
      return;
    }
    if (!parsedData.rows) {
      parsedData.rows = [];
    }

    // Compute next serial
    let nextSerial = parsedData.rows.length + 1;
    const newRow = {
      "serial_number": nextSerial,
      "name": "",
      "quantity": ""
    };
    parsedData.rows.push(newRow);

    imageData[currentImageIndex].output = JSON.stringify(parsedData, null, 2);
    displayOutput(currentImageIndex);
    // Auto-enable edit mode
    editMode = true;
    toggleRowEditMode(true);
    showToast("New row added. Edit mode enabled.", "info");
  });

  // EDIT ROW
  editRowBtn.addEventListener('click', () => {
    dropdownMenu.classList.add('hidden');
    if (imageData.length === 0 || !imageData[currentImageIndex]) {
      showToast("No data to edit.", "error");
      return;
    }
    // Toggle edit mode
    editMode = !editMode;
    if (editMode) {
      showToast("Edit mode enabled. Fields are now editable.", "info");
    } else {
      showToast("Edit mode disabled. Fields are read-only.", "info");
    }
    displayOutput(currentImageIndex);
  });

  // DELETE ROW
  deleteRowBtn.addEventListener('click', () => {
    dropdownMenu.classList.add('hidden');
    // Toggle deleteActive
    deleteActive = !deleteActive;
    if (deleteActive) {
      showToast("Click on a row to delete. Then confirm in the modal. (Click 'Delete Row' again to exit.)", "info");
    } else {
      showToast("Exited delete mode.", "info");
    }
  });

  // Row click -> triggers delete if in deleteActive
  ocrOutput.addEventListener('click', (event) => {
    const tr = event.target.closest('tr[data-row-index]');
    if (!tr) return;

    if (deleteActive) {
      deleteModal.classList.add('show');
      selectedRow = tr;
    }
  });

  cancelDeleteBtn.addEventListener('click', (event) => {
    event.preventDefault();
    deleteModal.classList.remove('show');
    selectedRow = null;
    exitDeleteMode();
  });

  confirmDeleteBtn.addEventListener('click', async () => {
    if (!selectedRow) {
      deleteModal.classList.remove('show');
      exitDeleteMode();
      return;
    }
    const rowIndex = parseInt(selectedRow.getAttribute('data-row-index'));
    deleteRow(rowIndex);

    deleteModal.classList.remove('show');
    selectedRow = null;
    exitDeleteMode();
  });

  deleteModalCloseX.addEventListener('click', () => {
    deleteModal.classList.remove('show');
    selectedRow = null;
    exitDeleteMode();
  });

  function exitDeleteMode() {
    if (deleteActive) {
      deleteActive = false;
      showToast("Exited delete mode.", "info");
    }
  }

  function deleteRow(rowIndex) {
    const rawJsonString = imageData[currentImageIndex].output;
    let parsedData;
    try {
      parsedData = JSON.parse(rawJsonString);
    } catch (err) {
      console.error("Error parsing JSON:", err);
      return;
    }

    if (parsedData && parsedData.rows && parsedData.rows[rowIndex]) {
      parsedData.rows.splice(rowIndex, 1);

      // Reassign serial numbers
      parsedData.rows.forEach((row, idx) => {
        row.serial_number = idx + 1;
      });

      imageData[currentImageIndex].output = JSON.stringify(parsedData, null, 2);
      displayOutput(currentImageIndex);
      showToast("Row deleted successfully.", "success");
    }
  }

  function gatherTableData() {
    let originalRaw = imageData[currentImageIndex].output;
    let parsedData;
    try {
      parsedData = JSON.parse(originalRaw);
    } catch (err) {
      parsedData = { title: "", rows: [], additional_notes: [] };
    }
    if (!parsedData.rows) {
      parsedData.rows = [];
    }

    const tableRows = ocrOutput.querySelectorAll('table tbody tr');
    const newRows = [];
    tableRows.forEach(tr => {
      const inputs = tr.querySelectorAll('textarea[data-field]');
      let rowObj = {};
      inputs.forEach(input => {
        const field = input.getAttribute('data-field');
        rowObj[field] = input.value.trim();
      });
      newRows.push(rowObj);
    });

    parsedData.rows = newRows;

    return JSON.stringify(parsedData, null, 2);
  }

  // SAVE BUTTON
  saveBtn.addEventListener('click', async () => {
    if (!threadName || threadNameLocked) {
      showToast('Please create/open a project first.', 'error');
      return;
    }
    if (imageData.length === 0 || !imageData[currentImageIndex]) {
      showToast('No image data available to save.', 'error');
      return;
    }

    try {
      const updatedRaw = gatherTableData();
      imageData[currentImageIndex].output = updatedRaw;

      const savePayload = {
        thread_name: imageData[currentImageIndex].thread_name,
        file_name: imageData[currentImageIndex].file_name || `Image${currentImageIndex + 1}`,
        structured_analysis: updatedRaw
      };

      const response = await fetch('/saveStructuredAnalysis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(savePayload)
      });

      if (!response.ok) {
        throw new Error('Failed to save changes. Server responded with an error.');
      }

      showToast("Changes saved successfully!", "success");
      editMode = false;
      displayOutput(currentImageIndex);
      exitDeleteMode();
    } catch (error) {
      console.error("Error while saving changes:", error);
      showToast("Error saving changes: " + error.message, "error");
    }
  });

  // DOWNLOAD BUTTON
  downloadBtn.onclick = async () => {
    if (!threadName || threadNameLocked) {
      showToast('Please create/open a project first.', 'error');
      return;
    }

    downloadMessage.innerHTML = `
      You are downloading an Excel file for the entire project:
      <span class="font-semibold text-gray-900">${threadName}</span>.
    `;
    downloadModal.classList.add('show');
  };

  if (confirmDownloadBtn) {
    confirmDownloadBtn.addEventListener('click', async () => {
      downloadModal.classList.remove('show');

      let totalImages = 0;
      try {
        const res = await fetch(`/getThreadImages?threadName=${encodeURIComponent(threadName)}`);
        if (res.ok) {
          const imagesData = await res.json();
          totalImages = imagesData.length;
        }
      } catch (err) {
        console.error('Error fetching images for progress calculation:', err);
      }

      downloadProgressSpan.classList.remove('hidden');
      downloadProgressSpan.textContent = '0%';

      if (totalImages === 0) {
        showToast(`No images found in project "${threadName}".`, 'info');
        await sleep(1000);
        downloadProgressSpan.textContent = '0%';
        downloadProgressSpan.classList.add('hidden');
        return;
      }

      const incrementPerImage = Math.floor(100 / totalImages);
      let currentProgress = 0;

      try {
        for (let i = 0; i < totalImages; i++) {
          await sleep(400);
          currentProgress += incrementPerImage;
          if (i === totalImages - 1) {
            currentProgress = Math.min(currentProgress, 90);
          }
          setDownloadProgress(currentProgress);
        }
        // Actual file download
        const downloadUrl = `/downloadAnalysis?threadName=${encodeURIComponent(threadName)}`;
        const response = await fetch(downloadUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        setDownloadProgress(100);

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = url;
        anchor.download = `${threadName}_structured_analysis.xlsx`;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        URL.revokeObjectURL(url);

      } catch (error) {
        console.error("Error downloading the file:", error);
        showToast("Failed to download the file. Please try again.", "error");
      } finally {
        await sleep(1200);
        downloadProgressSpan.textContent = '0%';
        downloadProgressSpan.classList.add('hidden');
      }
    });
  }

  function setDownloadProgress(value) {
    downloadProgressSpan.textContent = `${value}%`;
  }

  if (downloadModalCloseX) {
    downloadModalCloseX.addEventListener('click', () => {
      downloadModal.classList.remove('show');
    });
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // -------------------------
  // THREADS MODAL (Previous Projects)
  // -------------------------
  if (openThreadsButton) {
    openThreadsButton.addEventListener('click', () => {
      threadsModal.classList.add('show');
      fetchThreads();
    });
  }

  if (threadsModalCloseX) {
    threadsModalCloseX.addEventListener('click', () => {
      threadsModal.classList.remove('show');
    });
  }

  async function fetchThreads() {
    try {
      const res = await fetch('/getThreads');
      if (!res.ok) throw new Error('Error fetching threads');
      const threadsData = await res.json();

      threadsList.innerHTML = '';
      if (!threadsData.length) {
        threadsList.innerHTML = '<li class="p-2 text-gray-500">No threads found</li>';
      } else {
        threadsData.forEach((thread) => {
          const li = document.createElement('li');
          li.className = 'p-2 border border-gray-200 rounded hover:bg-gray-100 cursor-pointer';
          li.textContent = thread.thread_name || 'Unnamed Thread';

          if (thread.thread_name === threadName) {
            li.classList.add('selected-thread');
          }
          threadsList.appendChild(li);
        });
      }
    } catch (err) {
      console.error(err);
      alert('Failed to load threads');
    }
  }

  threadsList.addEventListener('click', async (event) => {
    if (!event.target.matches('li')) return;
    const chosenThread = event.target.innerText.trim();
    highlightSelectedThread(event.target);
    threadsModal.classList.remove('show');
    await loadThreadImages(chosenThread);
  });

  function highlightSelectedThread(selectedElement) {
    const allThreads = threadsList.querySelectorAll('li');
    allThreads.forEach(li => li.classList.remove('selected-thread'));
    selectedElement.classList.add('selected-thread');
    selectedThread = selectedElement.textContent.trim();
  }

/**
 * magnify(imgID, zoom)
 * Creates a rectangular lens sized ~300x200 over the image.
 * - Hides lens by default; shows on mousemove within buffer.
 * - Allows the lens to move 50px beyond the image on all sides.
 * - Cursor remains centered in the lens.
 * - Click once to pin (freeze) lens; click again to unpin.
 */
 function magnify(imgID, zoom) {
  const img = document.getElementById(imgID);
  if (!img) return;

  // Remove any existing lens to avoid duplicates
  const existingLens = img.parentElement.querySelector(".img-magnifier-glass");
  if (existingLens) existingLens.remove();

  // Create the lens
  const lens = document.createElement("DIV");
  lens.className = "img-magnifier-glass";
  img.parentElement.appendChild(lens);

  // Create the 'X' close button
  const closeBtn = document.createElement("DIV");
  closeBtn.className = "close-btn";
  closeBtn.innerHTML = '&times;'; // HTML entity for '×'
  lens.appendChild(closeBtn);

  // Set background properties for the lens
  lens.style.backgroundImage = `url('${img.src}')`;
  lens.style.backgroundSize = `${img.width * zoom}px ${img.height * zoom}px`;

  // Lens dimensions
  const lensWidth = 300;   // in pixels
  const lensHeight = 200;  // in pixels

  // Buffer in pixels
  const buffer = 50;

  // Track whether the lens is pinned (frozen)
  let pinned = false;

  // Function to get cursor position relative to the image
  function getCursorPos(e) {
    e = e || window.event;
    const rect = img.getBoundingClientRect();
    let x = e.pageX - rect.left - window.pageXOffset;
    let y = e.pageY - rect.top - window.pageYOffset;
    return { x, y };
  }

  // Function to move the lens
  function moveLens(e) {
    if (pinned) return; // Do not move if pinned

    e.preventDefault();
    const pos = getCursorPos(e);
    let x = pos.x;
    let y = pos.y;

    // Calculate allowed range with buffer
    const minX = -buffer;
    const maxX = img.width + buffer;
    const minY = -buffer;
    const maxY = img.height + buffer;

    // Check if cursor is within the buffer area
    if (x < minX || x > maxX || y < minY || y > maxY) {
      lens.style.display = "none";
      return;
    } else {
      lens.style.display = "block";
    }

    // Calculate the position of the lens
    const lensLeft = x - lensWidth / 2;
    const lensTop = y - lensHeight / 2;

    // Set lens position
    lens.style.left = `${lensLeft}px`;
    lens.style.top = `${lensTop}px`;

    // Set background position
    lens.style.backgroundPosition = `-${x * zoom - lensWidth / 2}px -${y * zoom - lensHeight / 2}px`;
  }

  // Event listeners for mouse and touch movements
  img.addEventListener("mousemove", moveLens);
  lens.addEventListener("mousemove", moveLens);
  img.addEventListener("touchmove", moveLens);
  lens.addEventListener("touchmove", moveLens);

  // Show lens when mouse enters image area or lens area
  img.parentElement.addEventListener("mouseenter", (e) => {
    if (!pinned) {
      lens.style.display = "block";
    }
  });

  // Hide lens when mouse leaves image area unless pinned
  img.parentElement.addEventListener("mouseleave", (e) => {
    if (!pinned) {
      lens.style.display = "none";
    }
  });

  // Handle click on the lens to toggle pin/unpin
  lens.addEventListener("click", (e) => {
    e.stopPropagation(); // Prevent triggering other click events

    if (!pinned) {
      // Pin the lens
      pinned = true;
      lens.classList.add("pinned");
      closeBtn.style.display = "block"; // Show 'X' button
    } else {
      // Unpin the lens
      pinned = false;
      lens.classList.remove("pinned");
      closeBtn.style.display = "none"; // Hide 'X' button

      // Check if cursor is still within buffer area
      const mouseX = e.pageX;
      const mouseY = e.pageY;
      const rect = img.getBoundingClientRect();
      const relativeX = mouseX - rect.left - window.pageXOffset;
      const relativeY = mouseY - rect.top - window.pageYOffset;

      if (relativeX < -buffer || relativeX > img.width + buffer || relativeY < -buffer || relativeY > img.height + buffer) {
        lens.style.display = "none";
      }
    }
  });

  // Handle click on the 'X' button to unpin and hide
  closeBtn.addEventListener("click", (e) => {
    e.stopPropagation(); // Prevent triggering the lens click event
    pinned = false;
    lens.classList.remove("pinned");
    closeBtn.style.display = "none";
    lens.style.display = "none";
  });

  // Prevent lens from blocking other interactions except the 'X' button
  lens.style.pointerEvents = "auto"; // Enable pointer events on lens
  closeBtn.style.pointerEvents = "auto"; // Ensure 'X' is clickable
}


  async function loadThreadImages(chosenThread) {
    try {
      const res = await fetch(`/getThreadImages?threadName=${encodeURIComponent(chosenThread)}`);
      if (!res.ok) throw new Error(`Error fetching images for thread: ${chosenThread}`);
      const imagesData = await res.json();

      imageData.length = 0;
      currentImageIndex = -1;

      threadName = chosenThread;
      displayedThreadName.innerText = chosenThread;
      analysisProjectLabel.textContent = chosenThread;
      threadNameLocked = false;
      enableUploadFeatures();

      if (!imagesData.length) {
        uploadMore.classList.add('hidden');
        uploadedImage.classList.add('hidden');
        uploadedImage.src = '';
        ocrOutput.innerHTML = '<p class="text-gray-500">No images found in this thread</p>';
        downloadBtn.classList.add('hidden');
        imageNav.classList.add('hidden');
        return;
      }

      for (const imgInfo of imagesData) {
        const latestAnalysis = imgInfo.latest_structured_analysis || imgInfo.structured_analysis;
        imageData.push({
          image: imgInfo.image_url || '',
          output: latestAnalysis || '',
          thread_name: chosenThread,
          file_name: imgInfo.file_name
        });
      }

      if (imageData.length) {
        updateImageNav();
        currentImageIndex = 0;
        switchImage(0);
        uploadMore.classList.remove('hidden');
        downloadBtn.classList.remove('hidden');
      }
    } catch (error) {
      console.error(error);
      alert('Error loading thread images. See console for details.');
    }
  }

  // KEYBOARD INTERACTIONS FOR MODALS
  document.addEventListener('keydown', function(event) {
    // Instruction Modal
    if (instructionModal.classList.contains('show')) {
      if (event.key === 'Enter') {
        event.preventDefault();
        instructionCloseBtn?.click();
      } else if (event.key === 'Escape') {
        event.preventDefault();
        instructionCloseBtn?.click();
      }
    }

    // New Project Modal
    if (newProjectModal.classList.contains('show')) {
      if (event.key === 'Enter') {
        event.preventDefault();
        confirmNewProjectBtn.click();
      } else if (event.key === 'Escape') {
        event.preventDefault();
        newProjectModal.classList.remove('show');
      }
    }

    // Download Modal
    if (downloadModal.classList.contains('show')) {
      if (event.key === 'Escape') {
        event.preventDefault();
        downloadModal.classList.remove('show');
      }
    }

    // Delete Modal
    if (deleteModal.classList.contains('show')) {
      if (event.key === 'Escape') {
        event.preventDefault();
        deleteModal.classList.remove('show');
        selectedRow = null;
        exitDeleteMode();
      }
    }

    // Threads Modal
    if (threadsModal.classList.contains('show')) {
      if (event.key === 'Escape') {
        event.preventDefault();
        threadsModal.classList.remove('show');
      }
    }
  });

  // ON DOM LOADED
  const lastThread = "{{ last_thread or '' }}";
  document.addEventListener('DOMContentLoaded', async () => {
    if (lastThread) {
      instructionMessage.innerHTML = `
        You were working on
        <span style="color: #008000;">${lastThread}</span>.
        You can continue or create a new project if you wish.
      `;
    } else {
      instructionMessage.textContent =
        "To begin, please create or open a project using 'New Project' or 'Open Projects' above.";
    }
    instructionModal.classList.add('show');

    // Attempt to load lastThread
    if (lastThread) {
      await loadThreadImages(lastThread);
    } else {
      disableUploadFeatures();
    }

    if (instructionCloseBtn) {
      instructionCloseBtn.addEventListener('click', () => {
        instructionModal.classList.remove('show');
      });
    }
  });
</script>

</body>
</html>
